<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Micro SaaS WhatsApp</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #1e1e2f;
      --card: #2c2c3e;
      --text: #f1f1f1;
      --accent: #00cec9;
      --danger: #e74c3c;
      --light-bg: #f5f6fa;
      --light-card: #ffffff;
      --light-text: #333;
    }
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      display: flex; height: 100vh; margin: 0;
      background: var(--bg); color: var(--text);
    }
    body.light { background: var(--light-bg); color: var(--light-text); }

    /* Sidebar */
    .sidebar { width: 230px; background:#11111a; padding:20px; display:flex; flex-direction:column; }
    body.light .sidebar{ background:#eaeaea; }
    .sidebar h1{ font-size:1.4em; margin:0 0 20px; text-align:center; font-weight:600; color:var(--accent); }
    .sidebar nav a{
      display:block; padding:10px 12px; margin:6px 0; border-radius:8px;
      text-decoration:none; color:var(--text); font-weight:500; transition:.25s;
    }
    body.light .sidebar nav a{ color:var(--light-text); }
    .sidebar nav a:hover{ background:var(--accent); color:#000; }

    /* Main / Cards */
    .main{ flex:1; padding:28px; overflow-y:auto; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:24px; }
    @media (max-width: 960px){ .grid{ grid-template-columns:1fr; } }
    .card{
      background:var(--card); border-radius:12px; padding:20px;
      box-shadow:0 6px 18px rgba(0,0,0,.25);
    }
    body.light .card{ background:var(--light-card); box-shadow:0 6px 16px rgba(0,0,0,.08); }
    h2{ margin:0 0 14px; color:var(--accent); font-size:1.25rem; }
    label{ display:block; margin-top:10px; font-weight:600; }

    input, textarea, select, button{
      width:100%; margin-top:6px; padding:12px; border:none; border-radius:8px;
      font: 14px 'Poppins', sans-serif;
    }
    input, textarea, select{ background:#3a3a4f; color:var(--text); }
    body.light input, body.light textarea, body.light select{ background:#f0f0f0; color:#000; border:1px solid #ddd; }

    /* Caixa de mensagem maior */
    textarea#msg-text{ height:200px; min-height:200px; resize:vertical; line-height:1.6; }

    button{
      background:var(--accent); color:#000; font-weight:700; cursor:pointer; transition:.25s; margin-top:14px;
    }
    button:hover{ opacity:.9; }

    /* Lista de contatos */
    ul{ list-style:none; padding:0; margin:12px 0 0; }
    li{
      background:#3a3a4f; color:var(--text); padding:10px 12px; margin:6px 0; border-radius:8px;
      display:flex; align-items:center; justify-content:space-between;
    }
    body.light li{ background:#f0f0f0; color:#000; }
    .danger{ background:var(--danger); color:#fff; padding:6px 10px; border-radius:6px; width:auto; }

    /* Accordion (Op√ß√µes Extras) */
    .accordion{ margin-top:15px; border:1px solid rgba(255,255,255,.12); border-radius:10px; overflow:hidden; }
    body.light .accordion{ border:1px solid rgba(0,0,0,.12); }
    .accordion-header{
      width:100%; text-align:left; padding:12px 14px; background:rgba(0,0,0,.2);
      color:var(--accent); font-weight:700; border:none; cursor:pointer;
    }
    body.light .accordion-header{ background:rgba(0,0,0,.05); }
    .accordion-content{ max-height:0; overflow:hidden; transition:max-height .35s ease, padding .25s ease; padding:0 14px; }
    .accordion-content.open{ max-height:1000px; padding:14px; }

    /* Bot√£o para mostrar campos de bot√µes */
    .btn-toggle{
      background:var(--accent); color:#000; font-weight:700; border:none; border-radius:8px;
      padding:10px 12px; cursor:pointer; width:100%; text-align:center; margin-top:6px;
    }
    .btn-toggle:hover{ background:#00b4aa; color:#fff; }

    /* Linhas de bot√µes (URL/REPLY) */
    .buttons-grid{
      display:grid; grid-template-columns: 130px 1fr 1fr; gap:10px; align-items:center; margin-top:10px;
    }
    .buttons-grid label{ margin:0; font-weight:600; }
    .muted{ opacity:.8; font-weight:500; }

    /* Pr√©-visualiza√ß√£o estilo WhatsApp */
    .preview-box{ background:#202c33; color:#fff; padding:14px; border-radius:12px; max-width:340px; }
    body.light .preview-box{ background:#e5ddd5; color:#000; }
    .preview-text{ white-space:pre-wrap; margin:0 0 10px; }
    .preview-buttons{ display:flex; flex-direction:column; gap:8px; }
    .preview-btn{ background:#00a884; color:#fff; text-align:center; padding:8px; border-radius:6px; font-weight:700; }
    body.light .preview-btn{ background:#128c7e; }

    /* Resposta */
    .response{ background:#111; color:#f1f1f1; padding:12px; border-radius:10px; max-height:260px; overflow:auto; white-space:pre-wrap; }
    body.light .response{ background:#f7f7f7; color:#111; }
    .hint{ font-size:12px; opacity:.8; margin-top:4px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 640px){ .row{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>üì≤ WhatsApp SaaS</h1>
    <nav>
      <a href="#contacts">üë• Contatos</a>
      <a href="#send-message">üí¨ Mensagem</a>
      <a href="#preview">üëÄ Pr√©via</a>
      <a href="#response">üìä Resposta</a>
    </nav>
  </div>

  <div class="main">
    <div class="grid">
      <!-- COLUNA ESQUERDA -->
      <div>
        <!-- Contatos -->
        <div class="card" id="contacts">
          <h2>üë• Contatos</h2>
          <div class="row">
            <div>
              <label>Nome</label>
              <input type="text" id="contact-name" placeholder="Ex.: Jo√£o Silva" />
            </div>
            <div>
              <label>Telefone</label>
              <input type="text" id="contact-phone" placeholder="Ex.: 11999999999" />
            </div>
          </div>
          <button onclick="addManualContact()">‚ûï Adicionar contato</button>

          <label style="margin-top:14px;">Anexar planilha de contatos (CSV)</label>
          <input type="file" id="contact-file" accept=".csv" />
          <div class="hint">Formato esperado do CSV: <code>nome,telefone</code> ‚Äî uma linha por contato.</div>
          <div class="row">
            <button onclick="uploadCSV()">üìÇ Importar CSV</button>
            <button onclick="downloadExample()">‚¨áÔ∏è Baixar modelo CSV</button>
          </div>

          <h3 style="margin:16px 0 8px;">Lista de contatos</h3>
          <ul id="contact-list"></ul>
          <div class="hint" id="contact-count">0 contato(s)</div>
        </div>

        <!-- Configura√ß√µes -->
        <div class="card" id="settings">
          <h2>‚öôÔ∏è Configura√ß√µes</h2>
          <label>Delay entre mensagens (ms)</label>
          <input type="number" id="delay" value="3000" min="500" />
          <div class="hint">Aumente para reduzir risco de bloqueio (ex.: 5000 = 5s).</div>
        </div>
      </div>

      <!-- COLUNA DIREITA -->
      <div>
        <!-- Mensagem -->
        <div class="card" id="send-message">
          <h2>üí¨ Mensagem</h2>
          <label>Corpo da mensagem</label>
          <textarea id="msg-text" oninput="updatePreview()">Ol√° {nome}, tudo certo?</textarea>
          <div class="hint">Use <code>{nome}</code> para personalizar com o nome do contato.</div>

          <!-- Accordion: Op√ß√µes Extras -->
          <div class="accordion">
            <button class="accordion-header" onclick="toggleAccordion()">‚ûï Op√ß√µes Extras (bot√µes)</button>
            <div class="accordion-content" id="buttons-area">
              <button class="btn-toggle" onclick="toggleButtons()">üéõÔ∏è Configurar Bot√µes</button>

              <!-- Campos de bot√µes (URL/REPLY) -->
              <div id="buttons-fields" style="display:none; margin-top:12px;">
                <!-- Button rows -->
                <div class="buttons-grid">
                  <label class="muted">Bot√£o 1</label>
                  <select id="btn1-type" onchange="updateButtonPlaceholders(1);updatePreview()">
                    <option value="URL">URL</option>
                    <option value="REPLY">REPLY</option>
                  </select>
                  <input type="text" id="btn1-label" placeholder="Texto do bot√£o" oninput="updatePreview()" />
                </div>
                <input type="text" id="btn1-action" placeholder="https://exemplo.com (ou texto do reply)" oninput="updatePreview()" />

                <div class="buttons-grid">
                  <label class="muted">Bot√£o 2</label>
                  <select id="btn2-type" onchange="updateButtonPlaceholders(2);updatePreview()">
                    <option value="URL">URL</option>
                    <option value="REPLY">REPLY</option>
                  </select>
                  <input type="text" id="btn2-label" placeholder="Texto do bot√£o" oninput="updatePreview()" />
                </div>
                <input type="text" id="btn2-action" placeholder="https://exemplo.com (ou texto do reply)" oninput="updatePreview()" />

                <div class="buttons-grid">
                  <label class="muted">Bot√£o 3</label>
                  <select id="btn3-type" onchange="updateButtonPlaceholders(3);updatePreview()">
                    <option value="URL">URL</option>
                    <option value="REPLY">REPLY</option>
                  </select>
                  <input type="text" id="btn3-label" placeholder="Texto do bot√£o" oninput="updatePreview()" />
                </div>
                <input type="text" id="btn3-action" placeholder="https://exemplo.com (ou texto do reply)" oninput="updatePreview()" />

                <div class="row" style="margin-top:10px;">
                  <div>
                    <label>T√≠tulo (opcional)</label>
                    <input type="text" id="btn-title" placeholder="Ex.: Oferta dispon√≠vel" />
                  </div>
                  <div>
                    <label>Rodap√© (opcional)</label>
                    <input type="text" id="btn-footer" placeholder="Ex.: Toque em uma op√ß√£o" />
                  </div>
                </div>
              </div>
            </div>
          </div>

          <button onclick="sendToAll()">üöÄ Enviar</button>
        </div>

        <!-- Pr√©-visualiza√ß√£o -->
        <div class="card" id="preview">
          <h2>üëÄ Pr√©via</h2>
          <div id="preview-box" class="preview-box">
            <p class="preview-text">Digite sua mensagem...</p>
            <div id="preview-buttons" class="preview-buttons"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resposta -->
    <div class="card" id="response">
      <h2>üìä Resposta da API</h2>
      <div class="response" id="response-box"></div>
    </div>
  </div>

  <script>
    /* ======= CONTATOS ======= */
    let contacts = [];

    function addManualContact(){
      const name = document.getElementById("contact-name").value.trim();
      const phone = document.getElementById("contact-phone").value.trim();
      if(!name || !phone) return alert("Preencha nome e telefone");
      contacts.push({ name, phone });
      renderContacts();
      document.getElementById("contact-name").value = "";
      document.getElementById("contact-phone").value = "";
    }

    function renderContacts(){
      const list = document.getElementById("contact-list");
      list.innerHTML = "";
      contacts.forEach((c,i)=>{
        const li = document.createElement("li");
        li.innerHTML = `<span>${c.name} - ${c.phone}</span> <button class="danger" onclick="removeContact(${i})">‚ùå</button>`;
        list.appendChild(li);
      });
      document.getElementById("contact-count").textContent = contacts.length + " contato(s)";
    }

    function removeContact(i){ contacts.splice(i,1); renderContacts(); }

    function uploadCSV(){
      const fileInput = document.getElementById("contact-file");
      if(!fileInput.files.length) return alert("Selecione um arquivo .csv");
      const reader = new FileReader();
      reader.onload = e => {
        const raw = e.target.result;
        const lines = raw.replace(/\r/g,"").split("\n").filter(Boolean);
        lines.forEach((line, idx)=>{
          const parts = line.split(",").map(v=>v.trim());
          if(!parts.length) return;
          // pular cabe√ßalho se existir
          if(idx===0 && /nome/i.test(parts[0]) && /tel|fone/i.test(parts[1]||"")) return;
          const [name, phone] = parts;
          if(name && phone) contacts.push({ name, phone });
        });
        renderContacts();
      };
      reader.readAsText(fileInput.files[0]);
    }

    function downloadExample(){
      const csv = "nome,telefone\nJo√£o,11999999999\nMaria,11988888888";
      const blob = new Blob([csv], {type:"text/csv"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "modelo-contatos.csv"; a.click();
      URL.revokeObjectURL(url);
    }

    /* ======= UI EXTRAS ======= */
    function toggleAccordion(){
      document.getElementById("buttons-area").classList.toggle("open");
    }

    function toggleButtons(){
      const fields = document.getElementById("buttons-fields");
      const btn = document.querySelector(".btn-toggle");
      const show = fields.style.display === "none" || fields.style.display === "";
      fields.style.display = show ? "block" : "none";
      btn.textContent = show ? "‚ùå Ocultar Bot√µes" : "üéõÔ∏è Configurar Bot√µes";
      updatePreview();
    }

    function updateButtonPlaceholders(n){
      const type = document.getElementById(`btn${n}-type`).value;
      const action = document.getElementById(`btn${n}-action`);
      action.placeholder = (type === "URL")
        ? "https://exemplo.com"
        : "Texto do reply (ex.: Quero falar com suporte)";
    }

    /* ======= PR√âVIA ======= */
    function updatePreview(){
      const text = document.getElementById("msg-text").value || "";
      document.querySelector(".preview-text").textContent = text;

      const previewButtons = document.getElementById("preview-buttons");
      previewButtons.innerHTML = "";

      const buttonsVisible = document.getElementById("buttons-fields").style.display === "block";
      if(!buttonsVisible) return;

      const rows = [1,2,3];
      rows.forEach(n=>{
        const label = document.getElementById(`btn${n}-label`).value.trim();
        if(label){
          const el = document.createElement("div");
          el.className = "preview-btn";
          el.textContent = label;
          previewButtons.appendChild(el);
        }
      });
    }

    /* ======= ENVIO ======= */
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    async function sendToAll(){
      if(!contacts.length) return alert("Adicione contatos ou importe um CSV primeiro.");
      const delay = parseInt(document.getElementById("delay").value) || 3000;

      // Construir a√ß√µes de bot√µes (URL/REPLY) se vis√≠veis
      let buttonActions = [];
      const buttonsVisible = document.getElementById("buttons-fields").style.display === "block";
      if(buttonsVisible){
        [1,2,3].forEach(n=>{
          const type = (document.getElementById(`btn${n}-type`).value || "URL").toUpperCase();
          const label = document.getElementById(`btn${n}-label`).value.trim();
          const action = document.getElementById(`btn${n}-action`).value.trim();
          if(label && action){
            if(type === "URL"){
              buttonActions.push({ id:String(n), type:"URL", label, url:action });
            }else{
              buttonActions.push({ id:String(n), type:"REPLY", label, text:action });
            }
          }
        });
      }

      // Enviar para cada contato
      const msgTemplate = document.getElementById("msg-text").value || "";
      const title = document.getElementById("btn-title")?.value || "";
      const footer = document.getElementById("btn-footer")?.value || "";

      let results = [];
      for(const c of contacts){
        const payload = {
          phone: c.phone,
          message: msgTemplate.replace(/\{nome\}/gi, c.name)
        };

        if(buttonActions.length){
          payload.title = title || "Mensagem";
          payload.footer = footer || "Escolha uma op√ß√£o:";
          payload.buttonActions = buttonActions;
        }

        try{
          const res = await fetch("http://localhost:3000/send-message", {
            method:"POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          const json = await res.json();
          results.push({ contato: c, resposta: json });
        }catch(err){
          results.push({ contato: c, erro: err.message });
        }

        await sleep(delay);
      }

      document.getElementById("response-box").textContent = JSON.stringify(results, null, 2);
    }
  </script>
</body>
</html>
