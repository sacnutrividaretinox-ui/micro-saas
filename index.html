<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Micro SaaS WhatsApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background-color: #f4f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .btn-custom {
      background-color: #00bfa5;
      color: white;
      font-weight: 600;
    }
    textarea {
      min-height: 120px;
      resize: vertical;
    }
    table {
      width: 100%;
    }
    table th, table td {
      text-align: center;
      padding: 6px;
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h2 class="text-center mb-4">📲 Micro SaaS WhatsApp</h2>

    <!-- Conexão -->
    <div class="card p-4">
      <h5>Conexão WhatsApp</h5>
      <button class="btn btn-custom my-2" onclick="verificarStatus()">🔍 Verificar Status</button>
      <p id="status">Status: aguardando...</p>
      <div id="qrCode" class="text-center"></div>
    </div>

    <!-- Enviar Mensagem -->
    <div class="card p-4">
      <h5>Enviar Mensagem Única</h5>
      <div class="mb-3">
        <label for="phone" class="form-label">Telefone</label>
        <input type="text" id="phone" class="form-control" placeholder="Ex: 5594999999999">
      </div>
      <div class="mb-3">
        <label for="message" class="form-label">Mensagem</label>
        <textarea id="message" class="form-control" placeholder="Digite sua mensagem..."></textarea>
      </div>
      <button class="btn btn-custom w-100" onclick="enviarMensagem()">🚀 Enviar</button>
    </div>

    <!-- Upload de Contatos -->
    <div class="card p-4">
      <h5>📂 Enviar Mensagens em Massa</h5>
      <p>Faça upload de uma planilha <b>.csv</b> ou <b>.xlsx</b> com os números de telefone na primeira coluna.</p>
      <input type="file" id="fileInput" class="form-control mb-3" accept=".csv, .xlsx" />
      <div class="mb-3">
        <label for="bulkMessage" class="form-label">Mensagem para Envio em Massa</label>
        <textarea id="bulkMessage" class="form-control" placeholder="Digite a mensagem que será enviada a todos os contatos..."></textarea>
      </div>
      <button class="btn btn-custom w-100" onclick="enviarEmMassa()">📤 Enviar em Massa</button>
      <hr>
      <h6>📋 Contatos carregados:</h6>
      <table class="table table-bordered table-sm" id="contactsTable">
        <thead>
          <tr><th>#</th><th>Telefone</th><th>Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    // STATUS
    async function verificarStatus() {
      try {
        const res = await fetch("/status");
        const data = await res.json();
        document.getElementById("status").innerText =
          `Conectado: ${data.connected} | Celular: ${data.smartphoneConnected}`;
      } catch (err) {
        document.getElementById("status").innerText = "Erro ao verificar status!";
      }
    }

    // MENSAGEM ÚNICA
    async function enviarMensagem() {
      const phone = document.getElementById("phone").value;
      const message = document.getElementById("message").value;

      try {
        const res = await fetch("/send", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ phone, message })
        });

        const data = await res.json();
        alert("Mensagem enviada: " + JSON.stringify(data));
      } catch (err) {
        alert("Erro ao enviar mensagem!");
      }
    }

    // PROCESSAR UPLOAD DA PLANILHA
    let contatos = [];
    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        contatos = rows.map(r => r[0]).filter(Boolean); // pega só a primeira coluna
        const tbody = document.querySelector("#contactsTable tbody");
        tbody.innerHTML = "";

        contatos.forEach((telefone, i) => {
          const row = `<tr><td>${i+1}</td><td>${telefone}</td><td>Aguardando</td></tr>`;
          tbody.innerHTML += row;
        });
      };

      reader.readAsArrayBuffer(file);
    });

    // ENVIO EM MASSA
    async function enviarEmMassa() {
      const message = document.getElementById("bulkMessage").value;
      const tbody = document.querySelector("#contactsTable tbody").rows;

      for (let i = 0; i < contatos.length; i++) {
        try {
          const res = await fetch("/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone: contatos[i], message })
          });
          tbody[i].cells[2].innerText = "✅ Enviado";
        } catch (err) {
          tbody[i].cells[2].innerText = "❌ Erro";
        }
      }
    }
  </script>
</body>
</html>
